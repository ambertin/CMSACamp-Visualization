---
title: "NFL Visualization Project"
author: "Audrey & Nathan"
date: 6/14/19

output:
  slidy_presentation:
    incremental: true
---

<!--
TODO:
  * Try log transformation for wlratio over time.
  * Fix logos
-->


```{r, echo = FALSE, messages = FALSE, results='hide'}

# LOAD LIBRARIES
suppressMessages(library(readr))
suppressMessages(library(tidyverse))
suppressMessages(library(gridExtra))
suppressMessages(library(ggridges))
suppressMessages(library(ggthemes))
suppressMessages(library(plotly))
suppressMessages(library(cowplot))
suppressMessages(library(magick))

# LOAD DATA INTO FILE
suppressMessages(nfl <- read_csv("nfl_teams_season_summary.csv"))

# MUTATE VARIABLES
afc <- c("AFC East", "AFC North", "AFC South", "AFC West")
nfc <- c("NFC East", "NFC North", "NFC South", "NFC West")

nfl <- nfl %>% mutate(div_general = ifelse(division %in% afc, "AFC", "NFC"))
nfl <- nfl %>% mutate(WLRatio = wins/losses)

nfl_passrun <- nfl %>%
  mutate(pass = pass_off_total_yards_gained/(pass_off_total_yards_gained + run_off_total_yards_gained), run = run_off_total_yards_gained/(pass_off_total_yards_gained + run_off_total_yards_gained))

top10 <- c("NE", "GB", "CAR", "LA", "NO", "LAC", "PIT", "IND", "DEN", "ATL")
nfl_passrun <- nfl_passrun %>% filter(team %in% top10) %>% select(team, season, pass, run)
```


# Introduction

> - NFL summary data --> 2009 - 2018

### Focus: "Competitiveness" across the NFL

- Distributions of team success over time
- Differences across divisions (AFC vs NFC)
- Similarities in play styles (pass/run and offense/defense)
- Historical consistency of teams -- how likely are upsets?


***

# Data

- NFL season summaries from 2009 - 2018


### Identifying info:

- team name
- season
- division

### Outcome variables:

- wins/losses/ties
- points scored
- points allowed


***

# Data

### Offense / Defense Stats

- offensive points made

- expected points

- defensive points made

- expected defensive points

- broken up two ways:

    - passing vs running plays

    - per attempt vs total across season


***
# Manipulation: Creating New Variables

- more general divisions (removing north/south/east/west)
- win / loss ratio (wins / losses per season)
- win record (double positive, positive, negative, double negative)
- total offensive yards gained
- total defensive yards allowed

***

# Question 1: Competition by Division

```{r, echo = FALSE}
knitr::include_graphics("AFC-NFC.png")
```


- 2 Major Divisions:
    - National Football Conference (NFC)
    - American Football Conference (AFC)

- Does either division appear to have clear dominant teams, or do a variety of teams take the spotlight in different years?
- Is either division becoming more competitive over time (fewer outlier teams)?

***

- There are some extreme outliers
    - Green Bay and Carolina for the NFC
    - Patriots for the AFC
- But overall, not that much difference over time or difference between the divisions.

```{r, echo = FALSE, message = FALSE, fig.height = 4}
nfl %>%
    ggplot(aes(x=WLRatio, y=as.factor(season), fill = div_general)) +
        geom_density_ridges(alpha = 0.7) +
        geom_vline(xintercept=1) +
        labs(x = "Win / Loss Ratio", y = NULL, title = "Division Records Over Time", 
             fill = "Division") +
        theme_gray()
```

***

PLOT 2: TODO

***


# Question 2:  Consistency

- Are the top teams consistently good?
- How much variation is there between teams across the years?
- Is the NFL competitive in terms of upset possibilities?


***

## Graphing consistency

- Notable outliers: Carolina, Green Bay, Indianapolis

```{r, echo = FALSE, warning = FALSE}
ggplot(nfl, aes(x=reorder(team, WLRatio, FUN = median), y = WLRatio, fill = div_general)) +
  geom_boxplot() +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab(NULL) +
  ylab("Win / Loss Ratio") +
  labs(
    title = "The Top Teams Aren't Always Consistent",
    subtitle = "The NFL appears very competitive, with decent upset chances",
    fill = "Division") +
  geom_hline(
    yintercept = 1,
    linetype = "dashed",
    color = "red") -> p2

ggplotly(p2)
```

***

- A few teams that are consistently bad
- Outliers + variation = chance for upsets
- Divisions seem somewhat balanced in terms of skill

```{r, echo = FALSE, warning = FALSE}
ggplot(nfl, aes(x=reorder(team, WLRatio, FUN = median), y = WLRatio, fill = div_general)) +
  geom_boxplot() +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab(NULL) +
  ylab("Win / Loss Ratio") +
  labs(
    title = "The Top Teams Aren't Always Consistent",
    subtitle = "The NFL appears very competitive, with decent upset chances",
    fill = "Division") +
  geom_hline(
    yintercept = 1,
    linetype = "dashed",
    color = "red") +
  ylim(0,4.5) -> p2.2

ggplotly(p2.2)

```

***


# Question 3: Pass/Run


- Can teams remain competitive with different passing/running strategies?
- Does either passing or running dominate among the most competitive teams, or are play styles similar across all teams?


```{r, echo = FALSE}
knitr::include_graphics("running.jpeg")
```

***

- The top teams pass slightly more than the league average
    - Carolina's weird.
- However, the deviations aren't that large. The league tends to earn about a third of its yards through running.
    - Probably overall good for the "health" of the game; passing plays are more exciting and allow for bigger swings.

```{r, echo = FALSE, message = FALSE, out.height = '80%'}
nfl_passrun %>% gather(key = "type", value = "pct", pass, run) %>%
  group_by(team, type) %>%
  summarize(pct = mean(pct)) %>%
  ggplot(aes(x=team, y=pct, fill = type)) + 
    geom_bar(stat = "identity", position = "fill") + 
    geom_hline(yintercept = 0.331, linetype = "dashed") + 
    xlab(NULL) + 
    ylab("% of Offensive Yards") + 
    labs(title = "What Makes A Top Team? Running or Passing?", 
         subtitle = "The most competitive teams play similarly to each other, but pass more than average", 
         fill = "Play Type") +
    theme_gray() -> p3

ggplotly(p3)
```

***


# Question 4: Offense/Defense

- Are offense and defense equally important for a team to be competitive?
- What separates the good teams from the bad teams?


```{r, echo = FALSE}
knitr::include_graphics("positions.png")
```

***

-  There are very few teams that only have a good offense OR defense

-  Teams that perform well appear to be good at both
    - High scoring
    - Don't allow many points
    
    
```{r, echo = FALSE, message = FALSE, out.height = '80%'}

library(plotly)
nfl <- nfl %>% mutate(record = ifelse(WLRatio > 2, "Double Positive", ifelse(WLRatio >= 1, "Positive", ifelse(WLRatio >= 0.5, "Negative", "Double Negative"))),
                      total_offensive_gained = run_off_total_yards_gained + pass_off_total_yards_gained,
                      total_defensive_allowed = run_def_total_yards_allowed + pass_def_total_yards_allowed)

nfl$record <- factor(nfl$record, levels = c("Double Positive", "Positive", "Negative", "Double Negative"))

ggplot(nfl, aes(x=total_defensive_allowed, y=total_offensive_gained, col = record, label = team)) + geom_point() + scale_color_manual(breaks = c("Double Positive", "Positive", "Negative", "Double Negative"), values = c("green", "gold", "darkorange1", "red")) + labs(x = "Total Defensive Yards Allowed in Season", y = "Total Offensive Yards Gained in Season", col = "Win Record") + theme(legend.position = "bottom") -> p
ggplotly(p)
```    

***    
- What separates a bad team from the worst teams?
    - The *worst* teams have very poor offenses
    - A good defense does not guarantee that a team is competitive
    
&nbsp;

```{r, echo = FALSE, message = FALSE, out.height = '80%'}
ggplotly(p)
```



***    

- What separates a good team from a bad team?
    - Worse *defensive* performance
    - Offense is important, but you can't neglect your defense!
    
&nbsp;

```{r, echo = FALSE, message = FALSE, out.height = '80%'}
ggplotly(p)
```

***

- What separates a good team from a great team?
    - Sometimes defensive improvement, sometimes offensive
    - **Big Idea:** You can remain competitive with different styles of play!
    
&nbsp;

```{r, echo = FALSE, message = FALSE, out.height = '80%'}

ggplotly(p)
```



***
# Conclusions

- The NFL is very consistent, and has remained so over time
- There are only a few teams that perform extraordinarily well
    - These are typically not the same every season (except New England of course...)
- The best teams are not unbeatable
    - Outliers and high variance show a chance for upsets
- The best teams pass more than average, but teams that run more can also succeed
- Different balances of offense and defense can lead to success. Not only one strategy!

***

# Limitations

- Passing vs Running and Offense vs Defense stats would be more informative if per-game, rather than per-season
    - Allow much more direct comparisons between yards and points
    - Averaging across the season is less accurate

- Only have data since 2009. Older data might look different.

- In addition to win/loss, would have liked overall rank in season
    - Also, as with offense/defense analysis, game level win/loss data could provide more insight into how teams match up.


***

# Future Questions

- Can we determine the strength of the relationship between offense/defense and win probabilities?
    - Does one have a stronger mathematical relationship to chances of winning?
    
- How does game location (home vs. away) factor into competitiveness of the game?
    - Are matches more interesting when the home team is better or worse?
    
- Do injuries lead to more or less competitive games?

***






