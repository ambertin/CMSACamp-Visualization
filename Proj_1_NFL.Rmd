---
title: "Project 1 - NFL Summary Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(readr)
library(tidyverse)
```

```{r}
# Read data
nfl <- read_csv("nfl_teams_season_summary.csv")
```

Theme: Competitiveness

Research Questions:

1. Are any of the divisions getting stronger/more competitive over time?

Group by division (keeping all 8)
Compare w/ AFC vs NFC (not caring about N/S/E/W)

```{r}
afc <- c("AFC East", "AFC North", "AFC South", "AFC West")
nfc <- c("NFC East", "NFC North", "NFC South", "NFC West")


nfl <- nfl %>% mutate(div_general = ifelse(division %in% afc, "AFC", "NFC"))
nfl <- nfl %>% mutate(region = 
                        ifelse(division %in% c("AFC East", "NFC East"), "East",
                        ifelse(division %in% c("AFC North", "NFC North"), "North",
                        ifelse(division %in% c("AFC South", "NFC South"), "South",
                        "West"))))
```

```{r}
nfl <- nfl %>% mutate(WLRatio = wins/losses)
```

```{r}
nfl %>% ggplot(aes(x=WLRatio, col = region)) + geom_density() + facet_wrap(~div_general) + xlim(0,6)
```

Is the distribution of wins/losses tight or spread out?

Pull out most competitive teams for each division over the years

```{r}
#nfl %>% group_by(div_general, team) %>%
 # summarize(mean_WL = mean(WLRatio)) %>%
#  arrange(desc(mean_WL)) %>%
#  head(10)
```

```{r}
#top10 <- c("NE", "GB", "CAR", "LA", "NO", "LAC", "PIT", "IND", "DEN", "ATL")
```

```{r}
#topTeams <- nfl %>% filter(team %in% top10)
```

```{r}
top_teams_by_year <- nfl %>%
  group_by(season, div_general) %>%
  select(season, team, WLRatio) %>% top_n(n=1)
```

```{r}
ggplot(top_teams_by_year, aes(x=season, y=WLRatio, fill = team)) + geom_bar(stat = "identity", position = "dodge", col = "black") +
  facet_wrap(~div_general) + 
  scale_fill_manual(breaks = c("ATL", "CAR", "CIN", "DAL", "DEN", "GB", "IND", "KC", "LA", "LAC", "MIN", "NE", "NO", "PHI", "PIT", "SEA"),
                    values = c("darkred", "turquoise2", "darkorange2", "gray77", "black", "darkgreen", "darkblue", "red", "goldenrod2", "powderblue", "purple", "blue", "tan", "aquamarine4", "yellow", "chartreuse1"), 
                   labels = c("Atlanta Falcons", "Carolina Panthers", "Cincinnati Bengals", "Dallas Cowboys", "Denver Broncos", "Green Bay Packers", "Indianapolis Colts", "Kansas City Chiefs", "LA Rams", "LA Chargers", "Minnesota Vikings", "New England Patriots", "New Orleans Saints", "Philadelphia Eagles", "Pittsburgh Steelers", "Seattle Seahawks")) + theme_fivethirtyeight()
```

2. Which works better -- passing or running?

Among the winningest teams in each division, how much do they pass vs run? (as a percentage of total yards) 
Wins vs passing yards
Wins vs running yards

```{r}
nfl_passrun <- nfl %>%
  mutate(pass = pass_off_total_yards_gained/(pass_off_total_yards_gained + run_off_total_yards_gained), run = run_off_total_yards_gained/(pass_off_total_yards_gained + run_off_total_yards_gained))
```

```{r}
nfl_passrun <- nfl_passrun %>% filter(team %in% top10) %>% select(team, season, pass, run)
```

```{r}
nfl_passrun %>% gather(key = "type", value = "pct", pass, run) %>%
  group_by(team, type) %>%
  summarize(pct = mean(pct)) %>%
  ggplot(aes(x=team, y=pct, fill = type)) + geom_bar(stat = "identity", position = "fill") + geom_hline(yintercept = 0.331) + xlab(NULL) + ylab("% of Offensive Yards") + labs(title = "What Makes A Top Team? Running or Passing?", subtitle = "The most competitive teams play similarly to each other, but pass more than average")
```


3. Offensive vs defense importance for wins? Which is more impactful?

Look at a sample of the best teams and a sample of the worst teams.

See how many passing/running yards the defense allows.
Look at how many passing/running yards the offense makes.


```{r}
nfl <- nfl %>% mutate(point_ratio = points_scored/points_allowed)

nfl <- nfl %>% mutate(win_majority = ifelse(WLRatio > 0.5, "Win Majority", "Lose Majority"))

nfl <- nfl %>% mutate(games = wins + losses + ties,
                      avg_scored = points_scored / games,
                      avg_allowed = points_allowed / games)

nfl <- nfl %>% mutate(offense_strength = ifelse(avg_scored > 25, "High Scoring (>25 Points Scored/Game)", ifelse(avg_scored > 18, "Medium Scoring (>18)", "Low Scoring (<=18)")),
                      defense_strength = ifelse(avg_allowed < 18, "Strong (<18 Points Allowed/Game)", ifelse(avg_allowed < 25, "Medium (<25)", "Weak (>=25)")))
```

```{r}
nfl$offense_strength <- factor(nfl$offense_strength, levels = c("High Scoring (>25 Points Scored/Game)","Medium Scoring (>18)", "Low Scoring (<=18)"))
nfl$defense_strength <- factor(nfl$defense_strength, levels = c("Strong (<18 Points Allowed/Game)", "Medium (<25)", "Weak (>=25)"))

nfl %>% filter(season >= 2015) %>% ggplot(aes(x=point_ratio, y = WLRatio, col = offense_strength)) + geom_point(size = 2, alpha = 0.8) + facet_wrap(~defense_strength) + labs(x = "Points Scored / Points Allowed", y = "Win / Loss Ratio", title = "Offense and Defense Strength Since 2015", subtitle = "To win, you need a balance", col = "Offense Strength") + ylim(0, 5) + scale_color_manual(breaks = c("High Scoring (>25 Points Scored/Game)","Medium Scoring (>18)", "Low Scoring (<=18)"), values = c("green", "gold", "red")) + theme(legend.position = "bottom") + geom_hline(yintercept = 1, linetype = "dashed") + geom_vline(xintercept = 1.00, linetype = "dashed")
```



```{r}
ggplot(nfl, aes(x=reorder(team, avg_scored, FUN = median), y = avg_scored, fill = div_general)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab(NULL) + ylab("Avg Points Per Game") + labs(title = "The Top Teams Aren't Always Consistent", subtitle = "The NFL appears very competitive, with decent upset chances")
```


```{r}
ggplot(nfl, aes(x=reorder(team, WLRatio, FUN = median), y = WLRatio, fill = div_general)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab(NULL) + ylab("Win / Loss Ratio") + labs(title = "The Top Teams Aren't Always Consistent", subtitle = "The NFL appears very competitive, with decent upset chances") + geom_hline(yintercept = 1, linetype = "dashed", color = "red")
```



```{r}
library(gghighlight)
ggplot(nfl, aes(x=reorder(team, WLRatio, FUN = median), y = WLRatio, fill = div_general)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab(NULL) + ylab("Win / Loss Ratio") + labs(title = "The Top Teams Aren't Always Consistent", subtitle = "The NFL appears very competitive, with decent upset chances") + geom_hline(yintercept = 1, linetype = "dashed", color = "red") + ylim(0,5)
```